<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Espace Patient</title>
</head>

<body>
  <!-- Section de notification d'alerte -->
  <div *ngIf="showAlert" class="notification-alert" [ngClass]="'alert-' + alertType">
    <div class="alert-content">
      <span class="alert-icon">
        <ng-container [ngSwitch]="alertType">
          <span *ngSwitchCase="'success'">âœ“</span>
          <span *ngSwitchCase="'error'">âœ•</span>
          <span *ngSwitchCase="'info'">â„¹</span>
        </ng-container>
      </span>
      <span class="alert-message">{{ alertMessage }}</span>
      <button class="alert-close" (click)="hideNotification()">Ã—</button>
    </div>
  </div>

  <!-- Header avec Messagerie -->
  <div class="header">
    <div class="logo">
      <div class="logo-icon">+</div>
      <div class="logo-text">Medico</div>
    </div>

    <!-- Section Actions Utilisateur avec Messagerie -->
    <div class="user-actions">
      <!-- IcÃ´ne de messagerie -->
      <div class="message-icon-container" (click)="toggleMessagesPanel()">
        <div class="message-icon">
          ğŸ’¬
          <span class="message-badge" *ngIf="unreadMessagesCount > 0">
            {{ unreadMessagesCount }}
          </span>
        </div>
      </div>

      <!-- Profil utilisateur -->
      <div class="user-profile" (click)="toggleMenu()">
        <div class="img-profile">
          <div class="dropdown-menu" [class.show]="menuOpen">
            <button class="logout" (click)="logout()">DÃ©connexion</button>
          </div>
          ğŸ‘¤ {{ userName }}
        </div>
      </div>
    </div>
  </div>

  <!-- Panneau des messages -->
  <div class="messages-panel" [class.show]="showMessagesPanel && !showMessageDetail">
    <div class="messages-header">
      <h3>Messages</h3>
      <div class="messages-actions">
        <button class="mark-all-read-btn" *ngIf="unreadMessagesCount > 0" (click)="markAllAsRead()"
          title="Marquer tout comme lu">
          âœ“
        </button>
        <button class="close-panel-btn" (click)="toggleMessagesPanel()">Ã—</button>
      </div>
    </div>

    <div class="messages-list" *ngIf="appointmentNotifications.length > 0">
      <div *ngFor="let appointmentNotification of appointmentNotifications" class="message-item"
        [class.unread]="!appointmentNotification.read" (click)="openMessage(appointmentNotification)">

        <div class="message-icon-type">{{ getMessageIcon(appointmentNotification.type) }}</div>

        <div class="message-content">
          <div class="message-header-row">
            <span class="message-sender">{{ appointmentNotification.sender }}</span>
            <span class="message-date">{{ appointmentNotification.date }}</span>
          </div>
          <div class="message-subject">{{ appointmentNotification.subject }}</div>
          <div class="message-preview">{{ appointmentNotification.content | slice:0:60 }}...</div>
        </div>

        <button class="delete-message-btn" (click)="deleteMessage(appointmentNotification.id, $event)"
          title="Supprimer">
          ğŸ—‘ï¸
        </button>
      </div>
    </div>

    <div class="messages-empty" *ngIf="appointmentNotifications.length === 0">
      <div class="empty-icon">ğŸ“­</div>
      <p>Aucun message</p>
    </div>
  </div>

  <!-- DÃ©tail du message -->
  <div class="message-detail-panel" [class.show]="showMessageDetail" *ngIf="selectedMessage">
    <div class="message-detail-header">
      <button class="back-btn" (click)="closeMessageDetail()">â† Retour</button>
      <button class="delete-btn" (click)="deleteMessage(selectedMessage.id)">ğŸ—‘ï¸ Supprimer</button>
    </div>

    <div class="message-detail-content">
      <div class="detail-icon">{{ getMessageIcon(selectedMessage.type) }}</div>
      <h2>{{ selectedMessage.subject }}</h2>

      <div class="message-meta">
        <span class="sender-name">De: {{ selectedMessage.sender }}</span>
        <span class="message-date-detail">{{ selectedMessage.date }}</span>
      </div>

      <div class="message-body">
        <p>{{ selectedMessage.content }}</p>
      </div>
    </div>
  </div>

  <!-- Overlay pour fermer les panneaux -->
  <div class="messages-overlay" *ngIf="showMessagesPanel || showMessageDetail"
    (click)="showMessagesPanel = false; showMessageDetail = false">
  </div>

  <!-- Navigation -->
  <div class="nav">
    <ul class="nav-items">
      <li>
        <a href="#" [class.active]="isSectionActive('dashboard')" (click)="showSection('dashboard', $event)">Tableau de
          bord</a>
      </li>
      <li>
        <a href="#" [class.active]="isSectionActive('services')" (click)="showSection('services', $event)">Services</a>
      </li>
      <li>
        <a href="#" [class.active]="isSectionActive('appointments')" (click)="showSection('appointments', $event)">Mes
          rendez-vous</a>
      </li>
      <li>
        <a href="#" [class.active]="isSectionActive('advice')" (click)="showSection('advice', $event)">Conseils</a>
      </li>
      <li>
        <a href="#" [class.active]="isSectionActive('medical-file')"
          (click)="showSection('medical-file', $event)">Dossier mÃ©dical</a>
      </li>
    </ul>
  </div>

  <div class="main-content">
    <!-- Dashboard content -->
    <div id="dashboard-content" [style.display]="isSectionActive('dashboard') ? 'block' : 'none'">
      <div class="welcome-section">
        <div class="welcome-text">
          <p>Bienvenue <strong>{{ userName }}</strong></p>
          <p>Bienvenue dans votre espace de santÃ© personnel et sÃ©curisÃ©</p>
          <button class="appointment-btn" (click)="showSection('forms-file', $event)">
            Prendre un rendez-vous
          </button>
        </div>
      </div>

      <div class="dashboard-cards">
        <div class="card">
          <div class="card-icon"><i><img src="../../../../assets/fonts/calendar-green.png" alt="Rendez-vous"
                onerror="this.innerHTML='ğŸ“…'"></i></div>
          <h3>Rendez-vous</h3>
          <p>Prochain RDV: 12 Mai</p>
          <p>Dr. Martin - GÃ©nÃ©raliste</p>
        </div>

        <div class="card">
          <div class="card-icon"><i>ğŸ’Š</i></div>
          <h3>Mes mÃ©dicaments</h3>
          <p>2 prescriptions actives</p>
          <p>DerniÃ¨re mise Ã  jour: 30 avril</p>
        </div>

        <div class="card">
          <div class="card-icon"><i>ğŸ“‹</i></div>
          <h3>RÃ©sultats</h3>
          <p>3 analyses rÃ©centes</p>
          <p>Voir mes rÃ©sultats</p>
        </div>

        <div class="card">
          <div class="card-icon"><i>ğŸ“</i></div>
          <h3>Suivi santÃ©</h3>
          <p>Mises Ã  jour rÃ©guliÃ¨res</p>
          <p>Ajouter des donnÃ©es</p>
        </div>
      </div>
    </div>

    <!-- Services content -->
    <div id="services-content" [style.display]="isSectionActive('services') ? 'block' : 'none'">
      <div class="welcome-section">
        <div class="welcome-text">
          <p>Nos services mÃ©dicaux</p>
          <p>DÃ©couvrez l'ensemble des services proposÃ©s par notre plateforme</p>
        </div>
      </div>

      <div class="service-categories">
        <div class="service-category">
          <h3>Consultations</h3>
          <p>Consultations en prÃ©sentiel ou en tÃ©lÃ©consultation</p>
        </div>
        <div class="service-category">
          <h3>PrÃ©vention</h3>
          <p>Bilans de santÃ© et dÃ©pistages prÃ©ventifs</p>
        </div>
        <div class="service-category">
          <h3>Soins spÃ©cialisÃ©s</h3>
          <p>AccÃ¨s Ã  un rÃ©seau de spÃ©cialistes</p>
        </div>
      </div>

      <div class="service-list">
        <div class="service-item">
          <div class="service-icon">ğŸ‘¨â€âš•ï¸</div>
          <div class="service-details">
            <h4>Consultation mÃ©dicale</h4>
            <p>Consultation avec un mÃ©decin gÃ©nÃ©raliste pour tout problÃ¨me de santÃ©.</p>
            <button class="service-btn" (click)="showSection('forms-file', $event)">Prendre rendez-vous</button>
          </div>
        </div>

        <div class="service-item">
          <div class="service-icon">ğŸ–¥ï¸</div>
          <div class="service-details">
            <h4>TÃ©lÃ©consultation</h4>
            <p>Consultation vidÃ©o avec un professionnel de santÃ© sans vous dÃ©placer.</p>
            <button class="service-btn">DÃ©marrer une tÃ©lÃ©consultation</button>
          </div>
        </div>

        <div class="service-item">
          <div class="service-icon">ğŸ’‰</div>
          <div class="service-details">
            <h4>Vaccination</h4>
            <p>Service de vaccination pour adultes et enfants.</p>
            <button class="service-btn">Voir les disponibilitÃ©s</button>
          </div>
        </div>

        <div class="service-item">
          <div class="service-icon">ğŸ§ </div>
          <div class="service-details">
            <h4>Suivi psychologique</h4>
            <p>Consultations avec des psychologues qualifiÃ©s.</p>
            <button class="service-btn">En savoir plus</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Appointments content -->
    <div id="appointments-content" [style.display]="isSectionActive('appointments') ? 'block' : 'none'">
      <div class="welcome-section">
        <div class="welcome-text">
          <p>Mes rendez-vous</p>
          <p>Consultez et gÃ©rez l'ensemble de vos rendez-vous mÃ©dicaux</p>
          <button class="appointment-btn" (click)="showSection('forms-file', $event)">
            Nouveau rendez-vous
          </button>
        </div>
      </div>

      <div class="service-list" *ngFor="let app of tableauClasse">
        <div class="service-item" [ngClass]="'appointment-' + app.status">
          <div class="service-icon">ğŸ“…</div>
          <div class="service-details">
            <h4>INFORMATIONS DU RENDEZ-VOUS</h4>

            <!-- Informations personnelles -->
            <div class="info-section">
              <p><strong> Patient:</strong> {{ app.firstname }} {{ app.lastname }}</p>
              <p><strong> Email:</strong> {{ app.email }}</p>
              <p><strong> TÃ©lÃ©phone:</strong> {{ app.phone }}</p>
            </div>

            <!-- DÃ©tails du rendez-vous -->
            <div class="info-section">
              <p><strong> Date:</strong> {{ app.preferredDate}}</p>
              <p><strong> Heure:</strong> {{ app.preferredTime }}</p>
              <p><strong>Type:</strong>
                <span *ngIf="app.appointmentType === 'in-person'">En personne</span>
                <span *ngIf="app.appointmentType === 'video'">VidÃ©o</span>
              </p>
              <p><strong>Motif:</strong> {{ app.reason }}</p>
              <p><strong>SymptÃ´mes:</strong> {{ app.symptoms }}</p>
              <p *ngIf="app.additionalInfo">
                <strong>Info additionnelle:</strong> {{ app.additionalInfo }}
              </p>
            </div>

            <!-- Section Statut Zoom (Ã  ajouter dans le dashboard) -->
            <div *ngIf="activeSection === 'dashboard'" class="zoom-status-card card">
              <div class="card-icon">ğŸ¥</div>
              <h3>IntÃ©gration Zoom</h3>

              <div class="zoom-status-indicator" [ngClass]="zoomStatus">
                <span class="status-dot"></span>
                <span class="status-text">
                  {{
                  zoomStatus === 'connected' ? 'ConnectÃ©' :
                  zoomStatus === 'connecting' ? 'Connexion en cours...' :
                  'Non connectÃ©'
                  }}
                </span>
              </div>

              <div *ngIf="zoomStatus === 'disconnected'" class="zoom-actions">
                <button class="service-btn" (click)="connectZoom()">
                  ğŸ”— Connecter Zoom
                </button>
                <p class="zoom-help-text">
                  L'intÃ©gration Zoom permet de dÃ©marrer des tÃ©lÃ©consultations vidÃ©o.
                </p>
              </div>

              <div *ngIf="zoomStatus === 'connected'" class="zoom-actions">
                <button class="service-btn btn-success" (click)="refreshZoomToken()">
                  ğŸ”„ RafraÃ®chir la connexion
                </button>
                <p class="zoom-help-text">
                  Zoom est correctement configurÃ© pour les tÃ©lÃ©consultations.
                </p>
              </div>
            </div>

            <!-- Bouton Commencer avec Zoom (dans la section rendez-vous) -->
            <button *ngIf="isStatusValidated(app.status) && app.status !== 'started'"
              class="service-btn service-btn-start" [disabled]="!canStartAppointment(app)"
              [class.btn-ready]="canStartAppointment(app) && isZoomAuthenticated"
              [class.btn-warning]="canStartAppointment(app) && !isZoomAuthenticated"
               (click)="startTeleconsultation(app)">

              <span *ngIf="canStartAppointment(app) && isZoomAuthenticated">
                ğŸ¥ Commencer la tÃ©lÃ©consultation
              </span>
              <span *ngIf="canStartAppointment(app) && !isZoomAuthenticated">
                âš ï¸ Zoom non configurÃ©
              </span>
            </button>

            <!-- Informations de la rÃ©union Zoom -->
            <div *ngIf="app.status === 'started' && app.meetingUrl" class="zoom-meeting-info">
              <h4>ğŸ”— Lien de la rÃ©union Zoom</h4>
              <div class="meeting-link">
                <a [href]="app.meetingUrl" target="_blank" class="zoom-link">
                  {{ app.meetingUrl }}
                </a>
                <button class="btn-copy" (click)="copyToClipboard(app.meetingUrl)">
                  ğŸ“‹ Copier
                </button>
              </div>
              <button class="service-btn" (click)="joinExistingZoomMeeting(app)">
                ğŸ¥ Rejoindre la rÃ©union
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Message si aucun rendez-vous -->
      <div *ngIf="tableauClasse.length === 0" class="no-appointments">
        <p>ğŸ“… Vous n'avez aucun rendez-vous pour le moment</p>
        <button class="service-btn" [routerLink]="['/appointment/new']">
          â• Prendre un rendez-vous
        </button>
      </div>
    </div>

    <!-- Advice content -->
    <div id="advice-content" [style.display]="isSectionActive('advice') ? 'block' : 'none'">
      <div class="welcome-section">
        <div class="welcome-text">
          <p>Conseils santÃ©</p>
          <p>Retrouvez des conseils personnalisÃ©s pour maintenir votre santÃ©</p>
        </div>
      </div>
      <app-conseil></app-conseil>
    </div>

    <!-- Medical File content -->
    <div id="medical-file-content" [style.display]="isSectionActive('medical-file') ? 'block' : 'none'">
      <div class="welcome-section">
        <div class="welcome-text">
          <p>Mon dossier mÃ©dical</p>
          <p>AccÃ©dez Ã  vos informations mÃ©dicales en toute sÃ©curitÃ©</p>
          <button class="appointment-btn" (click)="downloadCompleteMedicalFile()">
            ğŸ“¥ TÃ©lÃ©charger mon dossier complet
          </button>
        </div>
      </div>

      <div class="service-categories">
        <div class="service-category">
          <h3>AntÃ©cÃ©dents</h3>
          <p>Historique mÃ©dical complet</p>
        </div>
        <div class="service-category">
          <h3>Analyses</h3>
          <p>RÃ©sultats d'examens rÃ©cents</p>
        </div>
        <div class="service-category">
          <h3>Traitements</h3>
          <p>MÃ©dicaments et prescriptions</p>
        </div>
        <div class="service-category">
          <h3>Allergies</h3>
          <p>Allergies et intolÃ©rances</p>
        </div>
      </div>

      <div class="service-list">
        <h3>Derniers documents mÃ©dicaux</h3>
        <div class="service-item" *ngFor="let file of medicalFiles">
          <div class="service-icon">{{ file.icon }}</div>
          <div class="service-details">
            <h4>{{ file.title }}</h4>
            <p><strong>Date:</strong> {{ file.date }}</p>
            <p><strong>{{ file.type }}:</strong> {{ file.location }}</p>
            <button class="service-btn" (click)="openMedicalFile(file.id)">
              ğŸ‘ï¸ Consulter
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Popup pour fichiers mÃ©dicaux -->
    <div class="popup-overlay" *ngIf="showMedicalFilePopup" (click)="closeMedicalFilePopup()">
      <div class="popup-modal" (click)="$event.stopPropagation()">
        <div class="popup-header">
          <h2>{{ selectedMedicalFile?.title }}</h2>
          <button class="popup-close" (click)="closeMedicalFilePopup()">&times;</button>
        </div>
        <div class="popup-content" [innerHTML]="selectedMedicalFile?.details"></div>
        <div class="popup-footer">
          <button class="service-btn"
            (click)="downloadMedicalFile(selectedMedicalFile?.fileUrl, selectedMedicalFile?.title)"
            style="margin-right: 10px">
            ğŸ“¥ TÃ©lÃ©charger
          </button>
          <button class="service-btn" (click)="printMedicalFile()" style="margin-right: 10px">
            ğŸ–¨ï¸ Imprimer
          </button>
          <button class="popup-btn-close" (click)="closeMedicalFilePopup()">Fermer</button>j
        </div>
      </div>
    </div>

    <!-- Formulaire de rendez-vous -->
    <div id="forms-file-content" [style.display]="isSectionActive('forms-file') ? 'block' : 'none'">
      <div class="welcome-text">
        <app-appoint></app-appoint>
      </div>
    </div>
  </div>
</body>

</html>