<!-- rendez-vous.component.html -->
<div class="dashboard-container">
  <div class="dashboard-header">
    <h2>Demande de rendez-vous m√©dical</h2>
    <p>
      Veuillez remplir ce formulaire pour prendre rendez-vous avec un
      professionnel de sant√©. Les champs marqu√©s d'un * sont obligatoires.
    </p>
  </div>

  <div class="dashboard-content">
    <form
      [formGroup]="appointmentForm"
      (ngSubmit)="onSubmit()"
      class="form-style"
    >
      <!-- √âtape 1 -->
      <div *ngIf="currentStep === 1" class="form-step">
        <h3 class="section-title">√âtape 1 : Informations personnelles</h3>

        <div class="form-row">
          <div class="form-group">
            <label for="firstname" class="required">Pr√©nom</label>
            <input type="text" id="firstname" formControlName="firstname" />
            <div
              *ngIf="
                appointmentForm.get('firstname')?.invalid &&
                appointmentForm.get('firstname')?.touched
              "
              class="error-message"
            >
              Ce champ est obligatoire.
            </div>
          </div>

          <div class="form-group">
            <label for="lastname" class="required">Nom</label>
            <input type="text" id="lastname" formControlName="lastname" />
            <div
              *ngIf="
                appointmentForm.get('lastname')?.invalid &&
                appointmentForm.get('lastname')?.touched
              "
              class="error-message"
            >
              Ce champ est obligatoire.
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="birthdate" class="required">Date de naissance</label>
            <input type="date" id="birthdate" formControlName="birthdate" />
            <div
              *ngIf="
                appointmentForm.get('birthdate')?.invalid &&
                appointmentForm.get('birthdate')?.touched
              "
              class="error-message"
            >
              Ce champ est obligatoire.
            </div>
          </div>

          <div class="form-group">
            <label for="gender">Sexe</label>
            <select
              id="gender"
              formControlName="gender"
              (change)="onGenderChange($event)"
              class="form-select"
            >
              <option value="">S√©lectionner</option>
              <option value="male">Homme</option>
              <option value="female">Femme</option>
              <option value="other">Autre</option>
            </select>
            <div
              *ngIf="
                hasError('gender', 'required') &&
                appointmentForm.get('gender')?.touched
              "
              class="error-message"
            >
              Ce champ est obligatoire.
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="email" class="required">Email</label>
          <input type="email" id="email" formControlName="email" />
          <div
            *ngIf="
              appointmentForm.get('email')?.invalid &&
              appointmentForm.get('email')?.touched
            "
            class="error-message"
          >
            <span *ngIf="appointmentForm.get('email')?.errors?.['required']"
              >Ce champ est obligatoire.</span
            >
            <span *ngIf="appointmentForm.get('email')?.errors?.['email']"
              >Veuillez saisir une adresse email valide.</span
            >
          </div>
        </div>

        <div class="form-group">
          <label for="phone" class="required">T√©l√©phone</label>
          <input type="tel" id="phone" formControlName="phone" />
          <div
            *ngIf="
              appointmentForm.get('phone')?.invalid &&
              appointmentForm.get('phone')?.touched
            "
            class="error-message"
          >
            Ce champ est obligatoire.
          </div>
        </div>

        <div class="form-group">
          <label for="insurance">Num√©ro de s√©curit√© sociale</label>
          <input type="text" id="insurance" formControlName="insurance" />
        </div>

        <div class="form-group">
          <button type="button" class="btn btn-primary" (click)="nextStep()">
            Suivant
          </button>
        </div>
      </div>

      <!-- √âtape 2 -->
      <div *ngIf="currentStep === 2" class="form-step">
        <h3 class="section-title">
          √âtape 2 : D√©tails du rendez-vous et informations m√©dicales
        </h3>

        <div class="form-section">
          <h3 class="section-title">D√©tails du rendez-vous</h3>

          <div class="form-group">
            <label for="doctorType" class="required">Type de m√©decin</label>
            <select id="doctorType" formControlName="doctorType">
              <option value="">S√©lectionner</option>
              <option value="general">M√©decin g√©n√©raliste</option>
              <option value="cardiology">Cardiologue</option>
              <option value="dermatology">Dermatologue</option>
              <option value="ophthalmology">Ophtalmologue</option>
              <option value="pediatrics">P√©diatre</option>
              <option value="psychiatry">Psychiatre</option>
              <option value="gynecology">Gyn√©cologue</option>
              <option value="orthopedics">Orthop√©diste</option>
              <option value="other">Autre sp√©cialiste</option>
            </select>
            <div
              *ngIf="
                appointmentForm.get('doctorType')?.invalid &&
                appointmentForm.get('doctorType')?.touched
              "
              class="error-message"
            >
              Ce champ est obligatoire.
            </div>
          </div>

          <div class="form-group" *ngIf="showOtherSpecialist()">
            <label for="otherSpecialist">Pr√©cisez le sp√©cialiste</label>
            <input
              type="text"
              id="otherSpecialist"
              formControlName="otherSpecialist"
            />
          </div>

          <div class="form-group">
            <label for="doctor">M√©decin (si vous avez une pr√©f√©rence)</label>
            <select id="doctor" formControlName="doctorId">
              <option [ngValue]="null">Selectionnez</option>
               <option *ngFor="let doctor of doctors" [ngValue]="doctor.id">
                 Dr. {{ doctor.name }}
               </option>
              <option [ngValue]="null">
                N'importe quel m√©decin disponible
              </option>
            </select>
          </div>
          

          <div class="form-group">
            <label for="appointmentType" class="required"
              >Mode de consultation</label
            >
            <select id="appointmentType" formControlName="appointmentType">
              <option value="">S√©lectionner</option>
              <option value="in-person">En pr√©sentiel</option>
              <option value="video">T√©l√©consultation (vid√©o)</option>
            </select>
            <div
              *ngIf="
                appointmentForm.get('appointmentType')?.invalid &&
                appointmentForm.get('appointmentType')?.touched
              "
              class="error-message"
            >
              Ce champ est obligatoire.
            </div>
          </div>

           <!-- <div class="form-group">
            <label for="preferredDate" class="required">Date souhait√©e</label>
            <input
              type="date"
              id="preferredDate"
              formControlName="preferredDate"
            /> -->
            <!-- <p class="hint">
              Veuillez s√©lectionner une date √† partir de demain
            </p>
            <div
              *ngIf="
                appointmentForm.get('preferredDate')?.invalid &&
                appointmentForm.get('preferredDate')?.touched
              "
              class="error-message"
            >
              Ce champ est obligatoire.
            </div> -->
          </div> 

          <!-- Section de s√©lection des cr√©neaux -->
          <div class="form-group">
            <label class="required">S√©lectionner un cr√©neau disponible</label>

            <!-- Message de chargement -->
            <div *ngIf="isLoadingCreneaux" class="loading-message">
              <p>‚è≥ Chargement des cr√©neaux disponibles...</p>
            </div>

            <!-- Message si aucun m√©decin s√©lectionn√© -->
            <div
              *ngIf="
                !appointmentForm.get('doctorId')?.value && !isLoadingCreneaux
              "
              class="info-message"
            >
              <p>
                ‚ÑπÔ∏è Veuillez d'abord s√©lectionner un m√©decin pour voir les
                cr√©neaux disponibles
              </p>
            </div>

            <!-- Message si aucun cr√©neau disponible -->
            <div 
              *ngIf="
                appointmentForm.get('doctorId')?.value &&
                creneauxFiltres.length === 0 &&
                !isLoadingCreneaux
              "
              class="warning-message"
            >
              <p>
                ‚ö†Ô∏è Aucun cr√©neau disponible pour ce m√©decin. Veuillez en
                s√©lectionner un autre ou contacter le cabinet.
              </p>
            </div>
<!-- 
            Filtre par date (optionnel) -->
            <!-- <div *ngIf="creneauxDisponibles.length > 0" class="date-filter">
              <label for="dateFilter">Filtrer par date (optionnel) :</label>
              <input
                type="date"
                id="dateFilter"
                [formControl]="dateFilterControl"
                class="form-control"
                [min]="getMinDate()"
              />
            </div>  -->

            <!-- Liste des cr√©neaux group√©s par date -->
            <div *ngIf="creneauxFiltres.length > 0" class="creneaux-container">
              <div
                *ngFor="let groupe of getCreneauxGroupesParDate()"
                class="date-group"
              >
                <h4 class="date-header">
                  {{ formatDate(groupe.date) }}
                </h4>
                <div class="creneaux-grid">
                  <div
                    *ngFor="let creneau of groupe.creneaux"
                    class="creneau-card"
                    [class.selected]="isCreneauSelected(creneau.id)"
                    (click)="selectCreneau(creneau)"
                  >
                    <div class="creneau-time">
                      <span class="time-icon">üïê</span>
                      <span class="time-text">
                        {{ formatHeure(creneau.heureDebut) }} -
                        {{ formatHeure(creneau.heureFin) }}
                      </span>
                    </div>

                    <div class="creneau-status">
                      <span class="badge-disponible">‚úì Disponible</span>
                    </div>

                    <div
                      *ngIf="isCreneauSelected(creneau.id)"
                      class="selected-indicator"
                    >
                      ‚úì S√©lectionn√©
                    </div>
                  </div>
                </div>
              </div>
            </div> 

            <!---Afficher le creneaux en fonction du docteur -->



            <!-- Message d'erreur si aucun cr√©neau s√©lectionn√© -->
            <div
              *ngIf="
                appointmentForm.get('creneauId')?.invalid &&
                appointmentForm.get('creneauId')?.touched
              "
              class="error-message"
            >
              Veuillez s√©lectionner un cr√©neau disponible.
            </div>
          </div>
        <!-- Informations m√©dicales -->
        <div class="form-section">
          <h3 class="section-title">Informations m√©dicales</h3>

          <div class="form-group">
            <label for="reason" class="required"
              >Type  de  consultation</label
            >
            <select id="reason" formControlName="reason">
              <option value="">S√©lectionner</option>
              <option value="consultation">Consultation g√©n√©rale</option>
              <option value="follow-up">Suivi m√©dical</option>
              <option value="emergency">Urgence non vitale</option>
              <option value="prescription">Renouvellement d'ordonnance</option>
              <option value="results">R√©sultats d'examens</option>
              <option value="other">Autre</option>
            </select>
            <div
              *ngIf="
                appointmentForm.get('reason')?.invalid &&
                appointmentForm.get('reason')?.touched
              "
              class="error-message"
            >
              Ce champ est obligatoire.
            </div>
          </div>

          <div class="form-group">
            <label for="symptoms"
              >Description des sympt√¥mes ou du probl√®me</label
            >
            <textarea
              id="symptoms"
              formControlName="symptoms"
              placeholder="Veuillez d√©crire vos sympt√¥mes, leur dur√©e, leur intensit√© et tout autre √©l√©ment pertinent..."
            ></textarea>
          </div>

          <div class="form-group">
            <label>Est-ce votre premi√®re visite ?</label>
            <div class="radio-group">
              <input
                type="radio"
                id="first-visit-yes"
                formControlName="firstVisit"
                value="yes"
              />
              <label for="first-visit-yes">Oui</label>
            </div>
            <div class="radio-group">
              <input
                type="radio"
                id="first-visit-no"
                formControlName="firstVisit"
                value="no"
              />
              <label for="first-visit-no">Non</label>
            </div>
          </div>

          <div class="form-group">
            <label for="allergies">Allergies connues</label>
            <input
              type="text"
              id="allergies"
              formControlName="allergies"
              placeholder="M√©dicaments, aliments, etc."
            />
          </div>

          <div class="form-group">
            <label for="medications">M√©dicaments actuellement pris</label>
            <textarea
              id="medications"
              formControlName="medications"
              placeholder="Nom du m√©dicament, dosage, fr√©quence..."
            ></textarea>
          </div>
        </div>

        <!-- Informations compl√©mentaires -->
        <div class="form-section">
          <h3 class="section-title">Informations compl√©mentaires</h3>

          <div class="form-group">
            <label for="additionalInfo">Informations suppl√©mentaires</label>
            <textarea
              id="additionalInfo"
              formControlName="additionalInfo"
              placeholder="Toute information que vous jugez utile de communiquer au m√©decin..."
            ></textarea>
          </div>

          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="consent" formControlName="consent" />
              <label for="consent" class="required"
                >Je consens au traitement de mes donn√©es de sant√© conform√©ment √†
                la politique de confidentialit√© de Medico</label
              >
              <div
                *ngIf="
                  appointmentForm.get('consent')?.invalid &&
                  appointmentForm.get('consent')?.touched
                "
                class="error-message"
              >
                Vous devez accepter les conditions pour continuer.
              </div>
            </div>
          </div>
        </div>

        <div class="button-group">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="previousStep()"
            [disabled]="isSubmitting"
          >
            Pr√©c√©dent
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="appointmentForm.invalid || isSubmitting"
          >
            <span *ngIf="isSubmitting">Envoi en cours...</span>
            <span *ngIf="!isSubmitting">Envoyer la demande</span>
          </button>
        </div>

        <div *ngIf="submitSuccess" class="success-message">
          Votre demande de rendez-vous a √©t√© envoy√©e avec succ√®s. Nous vous contacterons bient√¥t pour confirmer.
        </div>
        
        <div *ngIf="submitError" class="error-message">
          {{ submitError }}
        </div>
      </div>
    </form>
  </div>
</div>
